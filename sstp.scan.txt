#!/usr/bin/env bash
# Termux SSTP server fetch & TCP port test (ipspeed.info) with hamid-scanner

PAGE_URL="https://ipspeed.info/free-sstp.php"

# Colors
RED="\033[31m"; GREEN="\033[32m"; PURPLE="\033[35m"; RESET="\033[0m"

# hamid-scanner tag in a purple box
TAG="${PURPLE}┌───────────────┐\n│ hamid-scanner │\n└───────────────┘${RESET}"

echo "[*] Fetching SSTP servers..."
HTML="$(curl -fsSL "$PAGE_URL")" || { echo "[!] Fetch failed"; exit 1; }

# Extract hosts: look for host:port patterns
mapfile -t RAW_HOSTS < <(echo "$HTML" | grep -Eo '[a-zA-Z0-9.-]+\.[a-z]{2,6}:[0-9]{2,5}')

if [[ ${#RAW_HOSTS[@]} -eq 0 ]]; then
  echo "[!] No hosts found"
  exit 1
fi

# Get public IP
MY_IP="$(curl -fsSL https://api.ipify.org 2>/dev/null || echo 'unknown')"
echo "[*] Your public IP: $MY_IP"

echo "[*] Testing servers..."
for item in "${RAW_HOSTS[@]}"; do
  host="${item%%:*}"
  port="${item##*:}"
  [[ "$host" == "$port" ]] && port=443

  if timeout 5 bash -c "echo > /dev/tcp/${host}/${port}" 2>/dev/null; then
    echo -e "${GREEN}[OPEN] ${host}:${port}${RESET}\n$TAG"
  else
    echo -e "${RED}[CLOSED] ${host}:${port}${RESET}\n$TAG"
  fi
done
